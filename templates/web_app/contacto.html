{% extends 'base.html' %}
{% load static %}

{% block title %}
    {{ block.super }} - Contacto
{% endblock %}

{% block content %}
<div class="bg-white shadow-lg p-6 md:p-8 mx-auto max-w-4xl rounded-lg my-8">
    <h1 class="text-center text-gray-900 font-bold text-3xl mb-4">Contáctanos</h1>
    <p class="text-lg text-gray-600 text-center mb-8">Estamos aquí para ayudarte a encontrar la propiedad perfecta o responder a tus consultas.</p>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Nuestra Información</h2>
            <ul class="list-none text-gray-900 space-y-3 text-base">
                <li class="flex items-center"><i class="fas fa-map-marker-alt text-gray-900 mr-2 text-lg"></i> Av. Hipolito Yrigoyen, Quilmes, Buenos Aires</li>
                <li class="flex items-center"><i class="fas fa-phone-alt text-gray-900 mr-2 text-lg"></i> +123 456 7890</li>
                <li class="flex items-center"><i class="fas fa-envelope text-gray-900 mr-2 text-lg"></i> info@tuinmobiliaria.com</li>
               <!-- <li class="flex items-center"><i class="fab fa-whatsapp text-gray-900 mr-2 text-lg"></i> +123 456 7890 (<a href="#" class="text-blue-600 hover:underline">Haz clic para chatear</a>)</li>  -->
                <li class="flex items-center"><i class="fas fa-clock text-gray-900 mr-2 text-lg"></i> Lunes a Viernes: 9:00 - 18:00</li>
            </ul>

            <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-3">Síguenos en:</h3>
            <div class="flex space-x-6 justify-center md:justify-start text-4xl">
                <a href="#" class="text-gray-900 hover:text-gray-700"><i class="fab fa-facebook-square"></i></a>
                <a href="#" class="text-gray-900 hover:text-gray-700"><i class="fab fa-instagram"></i></a>
            </div>

            <div class="mt-6 w-full h-64 rounded-lg overflow-hidden shadow-md">
                <iframe
                    src="https://maps.google.com/maps?q=Quilmes%2C%20Buenos%20Aires&z=15&output=embed"
                    width="100%"
                    height="100%"
                    style="border:0;"
                    allowfullscreen=""
                    loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade">
                </iframe>
            </div>
        </div>

        <!-- FORMULARIO CON EMAILJS -->
        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Envíanos un mensaje</h2>
            <form id="contactForm" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label for="from_name" class="block text-base font-semibold mb-1">Nombre</label>
                    <input type="text" name="from_name" id="from_name" required>
                </div>
                <div>
                    <label for="from_email" class="block text-base font-semibold mb-1">Correo Electrónico</label>
                    <input type="email" name="from_email" id="from_email" required>
                </div>
                <div>
                    <label for="phone" class="block text-base font-semibold mb-1">Teléfono</label>
                    <input type="text" name="phone" id="phone">
                </div>
                <div>
                    <label for="message" class="block text-base font-semibold mb-1">Mensaje</label>
                    <textarea name="message" id="message" required></textarea>
                </div>

                <button type="submit" id="submitBtn" class="bg-blue-600 text-white w-full py-3 px-4 rounded hover:bg-blue-700 transition duration-200 text-lg mt-4">
                    <span class="submit-text">Enviar Mensaje</span>
                    <span class="loading-text hidden">Enviando...</span>
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Estilo para los campos de formulario */
    .space-y-4 input[type="text"],
    .space-y-4 input[type="email"],
    .space-y-4 textarea {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .space-y-4 input[type="text"]:focus,
    .space-y-4 input[type="email"]:focus,
    .space-y-4 textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
    }

    .space-y-4 textarea {
        min-height: 8rem;
        resize: vertical;
    }

    .toast {
        min-width: 300px;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        transform: translateX(400px);
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        opacity: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 600;
        backdrop-filter: blur(10px);
    }

    .toast.show {
        transform: translateX(0);
        opacity: 1;
    }

    .toast.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border-left: 4px solid #047857;
    }

    .toast.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border-left: 4px solid #b91c1c;
    }

    .toast-content {
        display: flex;
        align-items: center;
        flex-grow: 1;
    }

    .toast-icon {
        margin-right: 12px;
        font-size: 20px;
    }

    .toast-close {
        background: none;
        border: none;
        color: inherit;
        font-size: 18px;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: background-color 0.2s;
        margin-left: 12px;
    }

    .toast-close:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .loading {
        opacity: 0.7;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- EmailJS SDK -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script type="text/javascript">
    (function(){
        // Inicializar EmailJS con la clave pública desde variables de entorno
        emailjs.init('{{ EMAILJS_PUBLIC_KEY }}');
    })();

    // Función para mostrar toast notifications
    function showToast(message, type = 'success', duration = 5000) {
        const toastContainer = document.getElementById('toastContainer');
        
        // Crear el elemento toast
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        // Icono según el tipo
        const icon = type === 'success' ? '✓' : '✕';
        
        toast.innerHTML = `
            <div class="toast-content">
                <span class="toast-icon">${icon}</span>
                <span>${message}</span>
            </div>
            <button class="toast-close" onclick="removeToast(this.parentElement)">×</button>
        `;
        
        // Agregar al container
        toastContainer.appendChild(toast);
        
        // Trigger animation
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);
        
        // Auto remove
        setTimeout(() => {
            removeToast(toast);
        }, duration);
        
        return toast;
    }

    function removeToast(toast) {
        if (toast && toast.parentElement) {
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }
    }

    // Función para obtener parámetros de la URL
    function getURLParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    // Pre-llenar el formulario con datos de la propiedad si vienen en la URL
    document.addEventListener('DOMContentLoaded', function() {
        const propiedadId = getURLParameter('propiedad_id');
        const propiedadTitulo = getURLParameter('propiedad_titulo');
        const propiedadDireccion = getURLParameter('propiedad_direccion');
        const propiedadLocalidad = getURLParameter('propiedad_localidad');
        
        if (propiedadId && propiedadTitulo) {
            const messageField = document.getElementById('message');
            const mensajePreformateado = `Hola, estoy interesado/a en la propiedad "${propiedadTitulo}" ubicada en ${propiedadDireccion}, ${propiedadLocalidad}. Me gustaría recibir más información sobre esta propiedad. Gracias.`;
            
            if (messageField) {
                messageField.value = mensajePreformateado;
                messageField.focus();
            }
        }
    });

    document.getElementById('contactForm').addEventListener('submit', function(event) {
        event.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.querySelector('.submit-text');
        const loadingText = document.querySelector('.loading-text');
        
        // Mostrar estado de carga
        submitBtn.classList.add('loading');
        submitBtn.disabled = true;
        submitText.classList.add('hidden');
        loadingText.classList.remove('hidden');
        
        // Obtener información adicional de la propiedad si está disponible
        const propiedadId = getURLParameter('propiedad_id');
        const propiedadTitulo = getURLParameter('propiedad_titulo');
        
        // Parámetros del template
        const templateParams = {
            from_name: document.getElementById('from_name').value,
            from_email: document.getElementById('from_email').value,
            phone: document.getElementById('phone').value,
            message: document.getElementById('message').value,
            to_name: 'Equipo de Tu Inmobiliaria',
            // Información adicional de la propiedad
            propiedad_consultada: propiedadTitulo || 'Consulta general',
            propiedad_id: propiedadId || 'N/A'
        };
        
        // Enviar email usando EmailJS con variables de entorno
        emailjs.send('{{ EMAILJS_SERVICE_ID }}', '{{ EMAILJS_TEMPLATE_ID }}', templateParams)
            .then(function(response) {
                console.log('SUCCESS!', response.status, response.text);
                
                // Mostrar toast de éxito
                showToast('¡Mensaje enviado con éxito! Te contactaremos pronto.', 'success', 6000);
                
                // Limpiar formulario
                document.getElementById('contactForm').reset();
                
                // Scroll suave hacia arriba para mejor UX
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                
            }, function(error) {
                console.log('FAILED...', error);
                
                // Mostrar toast de error
                showToast('Error al enviar el mensaje. Por favor, inténtalo de nuevo.', 'error', 8000);
            })
            .finally(function() {
                // Restaurar botón
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                loadingText.classList.add('hidden');
            });
    });
</script>

<script src="https://kit.fontawesome.com/your-fontawesome-kit-id.js" crossorigin="anonymous"></script>
{% endblock %}