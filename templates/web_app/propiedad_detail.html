{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}
{% load humanize %}

{% block title %}
    {{ propiedad.titulo }} - TU INMOBILIARIA
{% endblock %}

{% block content %}
<div class="bg-white shadow-md rounded-lg p-6 mb-8">
    <h1 class="font-bold text-gray-900 text-3xl sm:text-4xl mb-2">{{ propiedad.titulo }}</h1>
    <p class="text-gray-600 text-lg sm:text-xl mb-6">{{ propiedad.direccion }}, {{ propiedad.localidad }}, {{ propiedad.provincia }}</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <div>
            {% if propiedad.imagen_principal %}
                <img id="mainImageDisplay"
                     src="{{ propiedad.imagen_principal.url }}"
                     alt="{{ propiedad.titulo }}"
                     class="w-full h-64 sm:h-80 md:h-96 object-cover rounded shadow-sm mb-4 cursor-pointer"
                     onclick="openLightbox(0)">
            {% else %}
                <img id="mainImageDisplay"
                     src="{% static 'img/placeholder.png' %}"
                     alt="Sin imagen"
                     class="w-full h-64 sm:h-80 md:h-96 object-cover rounded shadow-sm mb-4 bg-gray-200">
            {% endif %}

            {% if propiedad.imagenes.all or propiedad.imagen_principal %}
            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-4 gap-2">
                {% if propiedad.imagen_principal %}
                <div>
                    <img src="{{ propiedad.imagen_principal.url }}"
                         alt="{{ propiedad.titulo }}"
                         class="w-full h-20 sm:h-24 object-cover rounded shadow-sm cursor-pointer hover:opacity-75 transition"
                         onclick="changeMainImage('{{ propiedad.imagen_principal.url }}', this)">
                </div>
                {% endif %}
                {% for imagen in propiedad.imagenes.all %}
                    <div>
                        <img src="{{ imagen.imagen.url }}"
                             alt="{{ imagen.descripcion_corta|default:propiedad.titulo }}"
                             class="w-full h-20 sm:h-24 object-cover rounded shadow-sm cursor-pointer hover:opacity-75 transition"
                             onclick="changeMainImage('{{ imagen.imagen.url }}', this)">
                    </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div>
            <h2 class="font-bold text-blue-600 text-3xl sm:text-4xl mb-4">
                {# Lógica para mostrar los precios #}
                {% if propiedad.precio_pesos %}
                    <span class="text-blue-600">${{ propiedad.precio_pesos|formato_miles }}</span>
                    {% if propiedad.precio_usd %}
                        <span class="text-green-600 text-base align-bottom ml-2">U$S {{ propiedad.precio_usd|formato_miles }}</span>
                    {% endif %}
                {% elif propiedad.precio_usd %}
                    <span class="text-green-600">U$S {{ propiedad.precio_usd|formato_miles }}</span>
                {% else %}
                    Precio no especificado
                {% endif %}
            </h2>
            
            <div class="flex flex-wrap gap-2 mb-6">
                {% if propiedad.tipo %}<span class="bg-yellow-400 text-gray-900 text-sm px-3 py-1 rounded-full">{{ propiedad.get_tipo_display }}</span>{% endif %}
                {% if propiedad.tipo_operacion %}<span class="bg-green-500 text-white text-sm px-3 py-1 rounded-full">{{ propiedad.get_tipo_operacion_display }}</span>{% endif %}
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-gray-800 mb-6 text-base">
                {% if propiedad.ambientes %}
                    <div class="flex items-center">
                        <i class="fas fa-house-chimney text-blue-500 mr-2"></i><strong>Ambientes:</strong>&nbsp;{{ propiedad.ambientes }}
                    </div>
                {% endif %}
                {% if propiedad.dormitorios %}
                    <div class="flex items-center">
                        <i class="fas fa-bed text-blue-500 mr-2"></i><strong>Dormitorios:</strong>&nbsp;{{ propiedad.dormitorios }}
                    </div>
                {% endif %}
                {% if propiedad.banios %}
                    <div class="flex items-center">
                        <i class="fas fa-bath text-blue-500 mr-2"></i><strong>Baños:</strong>&nbsp;{{ propiedad.banios }}
                    </div>
                {% endif %} 
                
                <div class="flex items-center">
                    <i class="fas fa-car text-blue-500 mr-2"></i>
                    <strong>Cocheras:</strong>&nbsp;
                    {% if propiedad.cocheras %}
                        {{ propiedad.cocheras }}
                    {% else %}
                        Sin cochera
                    {% endif %}
                </div>
                
                {% if propiedad.metros_cuadrados_total %}
                    <div class="flex items-center">
                        <i class="fas fa-ruler-combined text-blue-500 mr-2"></i><strong>Sup. Total:</strong>&nbsp;{{ propiedad.metros_cuadrados_total|floatformat:2 }} m²
                    </div>
                {% endif %}
                {% if propiedad.metros_cuadrados_cubierta %}
                    <div class="flex items-center">
                        <i class="fas fa-vector-square text-blue-500 mr-2"></i><strong>Sup. Cubierta:</strong>&nbsp;{{ propiedad.metros_cuadrados_cubierta|floatformat:2 }} m²
                    </div>
                {% endif %}
                {% if propiedad.antiguedad %}
                    <div class="flex items-center">
                        <i class="fas fa-building text-blue-500 mr-2"></i><strong>Antigüedad:</strong>&nbsp;{{ propiedad.antiguedad }} años
                    </div>
                {% endif %}
                {% if propiedad.amenidades %}
                    <div class="flex items-center col-span-1 sm:col-span-2">
                        <i class="fas fa-star text-blue-500 mr-2"></i><strong>Amenidades:</strong>&nbsp;{{ propiedad.amenidades }}
                    </div>
                {% endif %}

                {# --- SECCIÓN PET-FRIENDLY --- #}
                {% if propiedad.acepta_mascotas %}
                <div class="col-span-1 sm:col-span-2">
                    <hr class="my-2 border-gray-200">
                    <strong class="flex items-center"><i class="fas fa-paw text-green-600 mr-2"></i>Acepta Mascotas:</strong> Sí
                    {% if propiedad.tipo_mascota_permitida and propiedad.tipo_mascota_permitida != 'no_especificado' %}
                        <span class="bg-blue-200 text-blue-800 text-xs px-2 py-1 rounded-full ml-2">{{ propiedad.get_tipo_mascota_permitida_display }}</span>
                    {% endif %}
                </div>
                {% endif %}
                {# --- FIN SECCIÓN PET-FRIENDLY --- #}
            </div>

            {% if propiedad.descripcion %}
                <h3 class="text-xl sm:text-2xl font-bold text-gray-900 mb-3">Descripción</h3>
                <p class="text-gray-700 leading-relaxed text-base mb-8">{{ propiedad.descripcion|linebreaksbr }}</p>
            {% endif %}

            {# --- BOTÓN "MÁS INFORMACIÓN, CONTÁCTANOS" --- #}
            <a href="{% url 'web_app:contacto' %}?propiedad_id={{ propiedad.id }}&propiedad_titulo={{ propiedad.titulo|urlencode }}&propiedad_direccion={{ propiedad.direccion|urlencode }}&propiedad_localidad={{ propiedad.localidad|urlencode }}"
               class="block w-full text-center bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-200 text-lg font-semibold mt-6">
                Más Información, Contáctanos
            </a>
            {# --- FIN BOTÓN --- #}
        </div>
    </div>

    <hr class="my-8 border-gray-200">

    {# --- SECCIÓN: DETALLES DE UBICACIÓN Y MAPA --- #}
    <div class="bg-gray-50 shadow-md rounded-lg p-6 mt-8">
        <h2 class="font-bold text-gray-900 text-2xl sm:text-3xl mb-4">Ubicación y Alrededores</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {# Columna de Detalles de Ubicación #}
            <div>
                <h3 class="font-semibold text-gray-800 text-xl mb-3">Detalles de la Zona</h3>
                <ul class="list-disc list-inside text-gray-700 space-y-2">
                    <li><strong>Dirección:</strong> {{ propiedad.direccion }}</li>
                    <li><strong>Localidad:</strong> {{ propiedad.localidad }}</li>
                    <li><strong>Provincia:</strong> {{ propiedad.provincia }}</li>
                    {% if propiedad.codigo_postal %}
                        <li><strong>Código Postal:</strong> {{ propiedad.codigo_postal }}</li>
                    {% endif %}
                    {% if propiedad.barrio %}
                        <li><strong>Barrio:</strong> {{ propiedad.barrio }}</li>
                    {% endif %}
                    {% if propiedad.cercania_transporte %}
                        <li><strong>Cercanía a Transporte:</strong> {{ propiedad.cercania_transporte }}</li>
                    {% endif %}
                    {% if propiedad.escuelas_cercanas %}
                        <li><strong>Escuelas Cercanas:</strong> {{ propiedad.escuelas_cercanas }}</li>
                    {% endif %}
                    {% if propiedad.comercios_cercanos %}
                        <li><strong>Comercios Cercanos:</strong> {{ propiedad.comercios_cercanos }}</li>
                    {% endif %}
                </ul>
                {% if propiedad.notas_ubicacion %}
                    <p class="mt-4 text-gray-600 text-sm italic">{{ propiedad.notas_ubicacion }}</p>
                {% endif %}
            </div>

            {# Columna de Mapa Interactivo #}
            <div>
                <h3 class="font-semibold text-gray-800 text-xl mb-3">Mapa de la Propiedad</h3>
                <div class="w-full h-80 bg-gray-200 rounded-lg overflow-hidden shadow-inner">
                    {% if propiedad.latitud and propiedad.longitud %}
                        <iframe
                            src="https://maps.google.com/maps?q={{ propiedad.latitud }},{{ propiedad.longitud }}&z=15&output=embed"
                            width="100%"
                            height="100%"
                            style="border:0;"
                            allowfullscreen=""
                            loading="lazy"
                            referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    {% elif propiedad.direccion and propiedad.localidad and propiedad.provincia %}
                        <iframe
                            src="https://maps.google.com/maps?q={{ propiedad.direccion|urlencode }},{{ propiedad.localidad|urlencode }},{{ propiedad.provincia|urlencode }}&z=15&output=embed"
                            width="100%"
                            height="100%"
                            style="border:0;"
                            allowfullscreen=""
                            loading="lazy"
                            referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    {% else %}
                        <div class="flex items-center justify-center h-full text-gray-500">
                            Mapa no disponible.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<div id="imageLightbox" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden" onclick="closeLightbox()">
    <div class="relative w-full h-full max-w-full max-h-full flex items-center justify-center" onclick="event.stopPropagation()">
        <button class="absolute top-4 right-4 text-white text-4xl leading-none font-bold z-50 focus:outline-none p-2" onclick="closeLightbox()">×</button>
        <div id="imageCarousel" class="relative w-full h-full flex items-center justify-center">
            <div class="flex transition-transform duration-300 ease-in-out h-full" id="carouselInner">
                </div>
            <button class="absolute top-1/2 left-4 -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-4 rounded-full hover:bg-opacity-75 focus:outline-none text-2xl" onclick="navigateCarousel(-1)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="absolute top-1/2 right-4 -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-4 rounded-full hover:bg-opacity-75 focus:outline-none text-2xl" onclick="navigateCarousel(1)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const mainImageDisplay = document.getElementById('mainImageDisplay');
    let currentActiveThumbnail = null;

    function changeMainImage(imageUrl, clickedThumbnail) {
        if (mainImageDisplay) {
            mainImageDisplay.src = imageUrl;
            if (currentActiveThumbnail) {
                currentActiveThumbnail.classList.remove('border-blue-500', 'border-2');
            }
            clickedThumbnail.classList.add('border-blue-500', 'border-2');
            currentActiveThumbnail = clickedThumbnail;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const firstThumbnail = document.querySelector('.grid.grid-cols-3 img');
        if (firstThumbnail) {
            firstThumbnail.classList.add('border-blue-500', 'border-2');
            currentActiveThumbnail = firstThumbnail;
        }
    });

    let currentImageIndex = 0;
    let imageUrls = [];

    function openLightbox(startIndex) {
        imageUrls = [];
        {% if propiedad.imagen_principal %}
            imageUrls.push("{{ propiedad.imagen_principal.url }}");
        {% endif %}
        {% for imagen in propiedad.imagenes.all %}
            imageUrls.push("{{ imagen.imagen.url }}");
        {% endfor %}

        const carouselInner = document.getElementById('carouselInner');
        carouselInner.innerHTML = '';

        imageUrls.forEach((url, index) => {
            const imgContainer = document.createElement('div');
            imgContainer.classList.add('flex-shrink-0', 'w-full', 'h-full', 'flex', 'items-center', 'justify-center');
            imgContainer.style.scrollSnapAlign = 'start';

            const img = document.createElement('img');
            img.src = url;
            img.alt = `Imagen ${index + 1}`;
            img.classList.add('max-h-full', 'max-w-full', 'object-contain', 'rounded-lg');
            imgContainer.appendChild(img);
            carouselInner.appendChild(img);
        });

        currentImageIndex = startIndex;
        updateCarousel();
        document.getElementById('imageLightbox').classList.remove('hidden');
    }

    function updateCarousel() {
        const carouselInner = document.getElementById('carouselInner');
        if (carouselInner) {
            carouselInner.style.transform = `translateX(-${currentImageIndex * 100}%)`;
        }
    }

    function navigateCarousel(direction) {
        currentImageIndex += direction;
        if (currentImageIndex < 0) {
            currentImageIndex = imageUrls.length - 1;
        } else if (currentImageIndex >= imageUrls.length) {
            currentImageIndex = 0;
        }
        updateCarousel();
    }

    function closeLightbox() {
        document.getElementById('imageLightbox').classList.add('hidden');
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && !document.getElementById('imageLightbox').classList.contains('hidden')) {
            closeLightbox();
        }
    });
</script>
<script src="https://kit.fontawesome.com/your-fontawesome-kit-id.js" crossorigin="anonymous"></script>
{% endblock %}
